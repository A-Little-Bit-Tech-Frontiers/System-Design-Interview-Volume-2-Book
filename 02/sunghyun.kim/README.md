# 주변 친구

## 개략적 설계안

<img width="449" alt="스크린샷 2024-06-20 오후 2 49 28" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/87420630/0f7ab972-7d98-497e-a6db-dab9d4990aa6">
<img width="592" alt="스크린샷 2024-06-20 오후 2 49 31" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/87420630/66a123ee-e695-4d12-a275-43c8cdafce59">

모바일 단말은 통신 연결 상태가 좋지 않은 경우도 있고, 사용할 수 있는 전력도 충분하지 않아 공용 백엔드를 사용하는 방법이 좀 더 실용적이다. <br>
여기서 백엔드는 다음과 같은 역할을 해야한다.

- 모든 활성 상태 사용자의 위치 변화 내역을 수신한다.
- 사용자 위치 변경 내역을 수신할 때마다 해당 사용자의 모든 활성 상태 친구를 찾아서 그 친구들의 단말로 변경 내역을 전달한다.
- 두 사용자 사이의 거리가 특정 임계치보다 먼 경우, 변경 내역을 전송하지 않는다.

<br>


<img width="711" alt="스크린샷 2024-06-20 오후 2 51 58" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/87420630/27207088-5983-4e7b-b471-4c56f520f538">


### 웹소켓 서버

친구 위치 정보 변경을 실시간에 가깝게 처리하는 유상태 서버 클러스터. <br>
각 클라이언트는 그 가운데 한 대와 웹소켓 연결을 지속적으로 유지한다. <br>
검색 반경 내 친구 위치가 변경되면 해당 내역은 이 연결을 통해 클라이언트로 전송된다.

웹소켓 버서는 주변 친구 기능을 이용하는 클라이언트의 초기화도 담당한다. <br>
모바일 클라이언트가 시작되면, 온라인 상태인 모든 주변 친구 위치를 해당 클라이언트로 전송하는 역할을 한다.

### 레디스 위치 정보 캐시

레디스는 활성 상태 사용자의 가장 최근 위치 정보를 캐시하는데 사용한다. <br>
TTL 필드를 사용하여, 이 기간이 지나면 해당 사용자는 비활성 상태로 바뀌고 그 위치 정보는 캐시에서 삭제된다.

### 레디스 펍/섭 서버

<img width="690" alt="스크린샷 2024-06-20 오후 2 55 30" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/87420630/20ecb98c-afb1-41dc-845c-93fe13a7dec9">

웹소켓 서버를 통해 수신한 특정 사용자의 위치 정보 변경 이벤트는 해당 사용자에게 배정된 펍/섭 채널에 발행한다. <br>
해당 사용자의 친구 각각과 연결된 웹소켓 연결 핸들러는 해당 채널의 구독자로 설정되어 있다. <br>
**따라서 특정 사용자의 위치가 바뀌면 해당 사용자의 모든 친구의 웹소켓 연결 핸들러가 호출된다.**

### 주기적 위치 갱신

1. 모바일 클라이언트가 위치가 변경된 사실을 로드밸런서에 전송한다.
2. 로드밸런서는 그 위치 변경 내역을 해당 클라이언트와 웹소켓 서버 사이에 설정된 연결을 통해 웹소켓 서버로 보낸다.
3. 웹소켓 서버는 해당 이벤트를 위치 이동 이력 데이터베이스에 저장한다.
4. 웹소켓 서버는 새 위치를 위치 정보 캐시에 보관한다. 또한 웹소켓 서버는 웹소켓 연결 핸들러 안의 변수에 해당 위치를 반영한다.
5. 레디스 펍/섭 채널에 발행된 새로운 위치 변경 이벤트는 모든 구독자에게 브로드캐스트된다. 이때 구독자는 위치 변경 이벤트를 보낸 사용자의 온라인 상태 친구들이다.
6. 메시지를 받은 웹소켓 서버는 새 위치를 보낸 사용자와 메시지를 받은 사용자 사이의 거리를 새로 계산한다.

<img width="681" alt="스크린샷 2024-06-20 오후 3 00 07" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/87420630/883d73db-67a0-421d-9071-ad2270bf4868">

## 상세 설계

### 웹소켓 서버

웹소켓 서버는 유상태 서버라 기존 서버를 제거할 떄는 주의해야 한다. 노드를 제거하기 전에 우선 기존 연결부터 종료될 수 있도록 해야 한다. <br>
이를 위해 로드밸런서가 인식하는 노드 상태를 연결 종료 중으로 변경해 둔다. 그러면 그 서버로는 새로운 웹소켓 연결이 만들어지지 않는다.

### 클라이언트 초기화

모바일 클라이언트는 기동되면 웹소켓 클러스터 내의 서버 가운데 하나와 지속성 웹소켓 연결을 맺는다. <br>
웹소켓 연결이 초기화되면, 클라이언트는 해당 모바일 단말의 위치를 전송한다.

### 분산 레디스 펍/섭 서버 클러스터

모든 채널은 서로 독립적이라서, 메시지를 발행할 사용자 ID를 기준으로 펍/섭 서버를 샤딩하면 된다. <br>

<img width="618" alt="스크린샷 2024-06-20 오후 3 04 37" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/87420630/be1f7274-33a1-42cb-8642-018806936d87">
<img width="548" alt="스크린샷 2024-06-20 오후 3 04 31" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/87420630/b8d05d8b-dc9e-4ae3-acd2-e6608c53ef0d">

1. 웹소켓 서버는 해시 링을 참조하여 메시지를 발행할 레디스 펍/섭 서버를 선정한다.
2. 웹소켓 서버는 해당 서버가 관리하는 사용자 채널에 위치 정보 변경 내역을 발행한다.

*구독할 채널이 존재하는 레디스 펍/섭 서버를 찾는 과정도 이와 동일하다.*