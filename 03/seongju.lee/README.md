# 구글맵

구글 맵과 같은 복잡한 제품은 설계에 앞서 어떤 기능에 초점을 맞추어야 하는지 확인해야 한다.

  
# 문제 이해 및 설계 범위 확정

  
## 기능 요구사항

- 사용자 위치 갱신
- 경로 안내 서비스(ETA, Estimated Time Arrival 서비스 포함)
- 지도 표시

  
## 비기능 요구사항

- 정확도: 사용자에게 잘못된 경로를 안내하면 안 된다.
- 부드러운 경로 표시: 클라이언트를 통해 제공되는 경로 안내 용도의 지도는 화면에 아주 부드럽게 표시되고 갱신되어야 한다.
- 데이터 및 배터리 사용량: 클라이언트는 가능한 한 최소한의 데이터와 배터리를 사용해야 한다. 모바일 단말에 아주 중요한 요구사항이다.
- 일반적으로 널리 통용되는 가용성 및 규모 확장성 요구사항을 만족해야 한다.


### 서버 대역폭

  
**서버 대역폭을 추정하기 위해서는 어떤 유형의 요청을 처리해야 하는지** 살펴봐야 한다. 서버가 처리해야 하는 요청은 크게 두 가지다.  
첫 번째는 경로 안내 요청으로, 클라이언트가 경로 안내 세션을 시작할 때 전송하는 메시지다. 두번째는 위치 갱신 요청이다.  
클라이언트가 경로 안내를 진행하는 동안 변경된 사용자 위치를 전송하는 메시지다. 이 위치 정보를 다양한 방식으로 활요할 수 있는데, 예를 들어 실시간 교통 상황 데이터 계산 과정의 입력으로도 이용될 수 있다.

이제 경로 안내 요청을 처리하기 위한 서버 대역폭을 분석해보자. 아래와 같은 상황을 가정해보자.

- DAU는 10억이고
- 각 사용자는 경로 안내 기능을 평균적으로 주당 35분 사용

이를 환산하면 주당 350억분, 하루에 50억 분이다.  
단순하게 매초 GPS 좌표를 전송한다고 하면, 하루 3000억 건의 요청이 발생하고, 이는 **3백만 QPS에 해당**한다.  
하지만 클라이언트가 매초 새로운 GPS 좌표를 보낼 필요가 없을 수도 있다. 가령 **이들 요청을 클라이언트 쪽에서 버퍼링을 통해 쓰기를 제어하면 QPS를 낮출 수 있을 것이다.**  
15초동안의 버퍼링을 통해 제어한다면 QPS는 20만으로 줄어든다. 최대 QPS는 평균치의 다섯 배 가량으로 가정하자. 따라서 위치 정보 갱신 요청은 최대 1백만 QPS이다.


  
# 설계안

  
## 위치 서비스

<img width="308" alt="image" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/67941526/46759457-eee9-4d63-93ab-415b7ba2cb79">

본 기본 설계안은 클라이언트가 t초마다 자기 위치를 전송한다고 가정한다. 여기서 t는 설정이 가능한 값이다.  
이렇게 주기적으로 위치 정보를 전송하면 몇 가지 좋은 점이 있다. 첫 번째는 **해당 데이터 스트림을 활용하여 시스템을 점차 개선**할 수 있다는 점이다. 
**실시간** 교통 상황을 모니터링하는 용도로 활용할 수도 있고, 새로 만들어진 도로나 폐쇄된 도로를 탐지할 수도 있고, 사용자 행동 양태를 분석하여 개인화된 경험을 제공하는 데 활용할 수도 있다.  
두 번째 장점은 클라이언트가 보내는 위치 정보가 거의 실시간 정보에 가까우므로 ETA를 좀 더 정확하게 산출할 수 있고, 교통 상황에 따라 다른 경로를 안내할 수도 있다는 점이다.

하지만 사용자 위치가 바뀔 때마다 그 즉시 서버로 전송해야만 할까? 아마 아닐 것이다. 위치 이력을 클라이언트에 버퍼링해 두었다가 일괄 요청(batch request)하면 전송 빈도를 줄일 수 있다.

<img width="468" alt="image" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/67941526/fce937c7-b902-4822-8c28-ddd3a111945e">

위 그림처럼 위치 변경 내역은 매초 측정하긴 하지만 서버로는 15초마다 한 번 보내도록 설정해놓은 사례다. 이렇게 하면 클라이언트가 보내는 요청의 양을 크게 줄일 수 있다. 

구글 맵과 같은 시스템은 이렇게 해서 위치 갱신 요청 빈도를 줄여도 여전히 많은 쓰기 요청을 처리해야만 한다. 따라서 **아주 높은 쓰기 요청 빈도에 최적화되어 있고 규모 확장이 용이한 카산드라 같은 데이터베이스가 필요**하다.  
또한 카프카 같은 **스트림 처리 엔진**을 활용하여 위치 데이터를 로깅해야 할 수도 있다.  

  

## 지도 표시
정적인 콘텐츠에 대해서 미리 데이터를 만들어 두어 캐싱해두면 성능을 높일 수 있다.  
또한, CDN을 두어 사용자에게 가장 가까운 POP(Point of Presence)에서 파일을 서비스하면, 데이터 사용량도 훨씬 줄일 수 있다.  

<img width="473" alt="image" src="https://github.com/A-Little-Bit-Tech-Frontiers/System-Design-Interview-Volume-2-Book/assets/67941526/7ce15f57-b5aa-4e59-8a7a-df7b783ffdc8">

- **데이터 사용량**
    
  사용자가 30km/h 속도로 이동 중이며, 한 이미지가 200mX200m 영역을 표현하도록 확대하여 지도를 표시하고 있는 상황이라고 하자.
  (이미지 하나는 256X256픽셀 이미지이며 평균 이미지 크기는 100KB이다.) 1kmX1km영역을 표현하려면 이미지 25장이 필요하며, 이는 저장 용량으로 환산하면 2.5MB(25X100KB)이다.
  그러므로 30km/h 속도로 이동한다고 하면 시간당 75MB의 데이터가 소진되며, 이는 분당 1.25MB에 해당한다.
    
- **CDN 데이터 사용량**
    
  매일 50억 분(min) 가량의 경로 안내를 처리한다. 이는 50억X1.25MB = 6.25PB/일 에 해당하는 양이다.
  그러므로 초당 전송 해야 하는 지도 데이터의 양은 62,500MB에 달한다. CDN을 사용하면 이 지도 이미지는 전 세계에 흩어져 있는 POP를 통해 제공될 것이다.
  전 세계에 200개의 POP가 있다고 하면, 각 POP는 수백 MB 정도의 트래픽만 처리하면 될 것이다.
