# 분산 이메일 서비스

## 전통적 메일 서버

<img width="591" alt="스크린샷 2024-07-18 오후 8 40 51" src="https://github.com/user-attachments/assets/275a428f-c814-447d-a2d0-8b6bbaf7af5c">

## 분산 메일 서버

<img width="577" alt="스크린샷 2024-07-18 오후 8 42 09" src="https://github.com/user-attachments/assets/c50d19bf-b114-4f31-b439-1b43bdb04e1e">

- **웹메일**: 사용자는 웹브라우저를 사용해 메일을 받고 보낸다.
- **웹서버**: 사용자가 이용하는 요청/응답 서비스로 로그인, 가입, 사용자 프로파일 등에 대한 관리 기능을 담당한다.
- **실시간 서버**: 새로운 이메일 내역을 클라이언트에 실시간으로 전달하는 역할을 한다. stateful 서버이고 롱폴링, 웹소켓으로 실시간 통신 지원이 가능하다.
- **메타데이터 데이터베이스**: 이메일 제목, 본문, 발신인, 수신인 목록 등의 메타데이터를 저장하는 데이터베이스다.
- **첨부 파일 저장소**: S3같은 객체 저장소를 사용한다.
- **분산 캐시**: 최근에 수신된 이메일은 자주 읽을 가능성이 높으므로 메모리에 캐시해두면 메일을 표시하는 시간을 많이 줄일 수 있다.
- **검색 저장소**: 분산 문서 저장소다. 고속 텍스트 검색을 지원하는 inverted index를 자료구조로 사용한다.

### 이메일 전송 절차

<img width="776" alt="스크린샷 2024-07-18 오후 8 47 31" src="https://github.com/user-attachments/assets/96c39289-a272-4657-a03a-271813e143fa">


### 이메일 수신 절차

<img width="817" alt="스크린샷 2024-07-18 오후 8 48 47" src="https://github.com/user-attachments/assets/589694a2-3a11-46b5-bc68-efd1287c5fe4">

<br>

## 상세 설계

### 메타데이터 데이터베이스

> **이메일 메타데이터의 특성**
> - 이메일의 헤더는 작고, 빈번하게 사용된다.
> - 이메일의 본문 크기는 작은 것부터 큰 것까지 다양하지만, 사용 빈도는 낮다. 일반적으로 사용자는 이메일을 한 번만 읽는다.
> - 이메일 가져오기, 읽은 메일로 표시, 검색 등의 이메일 관련 작업은 사용자 별로 격리 수행되어야 한다.
> - 데이터의 신선도는 데이터 사용 패턴에 영향을 미친다. 사용자는 최근 메일만 읽는다.
> - 데이터의 높은 안정성이 보장되어야 한다.

따라서 데이터베이스를 선정할 때 아래의 조건을 충족시켜야 한다.

- 어떤 단일 컬럼의 크기는 한 자릿수 MB 정도일 수 있다.
- 강력한 데이터 일관성이 보장되어야 한다.
- 디스크 I/O가 최소화되도록 설계되어야 한다.
- 가용성이 아주 높아야 하고, 일부 장애를 감내할 수 있어야 한다.
- 증분 백업이 쉬워야 한다.

### 검색

이메일 검색은 제목이나 본문에 특정 키워드가 포함되었는지 찾아야 한다. <br>
고급 기능에는 발신인, 제목, 읽지 않음 같이 메일 속성에 따른 필터링 기능이 포함된다. <br>
검색 기능을 제공하려면 이메일이 전송, 수신, 삭제될 때마다 색인 작업을 수행해야 한다.

#### 방안 1: elastic search

<img width="525" alt="스크린샷 2024-07-18 오후 9 00 51" src="https://github.com/user-attachments/assets/3c24b2c6-2fc0-4a8e-aaf8-fafb6e2232d8">

#### 방안 2: 맞춤형 검색 솔루션

색인을 구축하는 프로세스는 다량의 쓰기 연산을 발생시킬 수밖에 없으므로 Log Structured Merge 트리를 사용하여, 디스크에 저장되는 색인을 구조화하는 것이 바람직하다. <br>
쓰기 경로는 순차적 쓰기 연산만 수행하도록 최적화되어 있다.

새로운 이메일이 도착하면 우선 메모리 캐시로 구현되는 0번 계층에 추가한다. <br>
메모리에 보관된 데이터의 양이 임계치를 넘으면 데이터는 다음 계층에 병합된다.

<img width="764" alt="스크린샷 2024-07-18 오후 9 09 24" src="https://github.com/user-attachments/assets/ef75e1f9-e2b7-45ae-974f-f80e9d9a3c20">















