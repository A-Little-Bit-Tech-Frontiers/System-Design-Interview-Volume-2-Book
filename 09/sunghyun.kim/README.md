# S3와 유사한 객체 저장소

## 개략적 설계안

<img width="637" alt="스크린샷 2024-07-29 오후 8 28 44" src="https://github.com/user-attachments/assets/31155a7b-4c52-49da-a1cb-8d1a101312f4">


- IAM 서비스
  - 인증, 권한 부여, 접근 제어 등을 중앙에서 맡아 처리한다. 인증은 호출 주체가 누구인지 확인하는 작업이고, 권한 부여는 인증된 사용자가 어떤 작업을 수행할 수 있는지 검증하는 과정이다.
- 데이터 저장소
  - 실제 데이터를 보관하고 필요할 때마다 읽어가는 저장소. 모든 데이터 관련 연산은 객체 ID를 통한다.
- 메타데이터 저장소
  - 객체 메타데이터를 저장하는 저장소.

### 객체 업로드

1. 클라이언트는 버킷을 생성하기 위해 HTTP PUT 요청을 보낸다.
2. API 서비스는 IAM을 호출하여 해당 사용자가 WRITE 권한을 가졌는지 확인한다.
3. API 서비스는 메타데이터 데이터베이스에 버킷 정보를 등록하기 위해 메타데이터 저장소를 호출한다. 버킷 정보가 만들어지면 그 사실을 알리는 메시지가 클라이언트에 전송된다.
4. 버킷이 만들어지고 나면 클라이언트는 script.txt 객체를 생성하기 위한 HTTP PUT 요청을 보낸다.
5. API 서비스는 해당 사용자 신원 및 WRITE 권한 소유 여부를 확인한다.
6. API 서비스는 HTTP PUT 요청 몸체에 실린 객체 데이터를 데이터 저장소로 보낸다. 데이터 저장소는 해당 데이터를 객체로 저장하고 해당 객체의 UUID를 반환한다.
7. API 서비스는 메타데이터 저장소를 호출하여 새로운 항목을 등록한다.

### 객체 다운로드

버킷은 디렉토리 같은 계층 구조를 지원하지는 않지만, 버킷 이름과 객체 이름을 연결하여 폴더 구조를 흉내내는 논리적 계층을 만들 수 있다.

1. 클라이언트는 GET /bucket-to-share/script.txt 요청을 로드밸런서로 보낸다. 로드밸런서는 이 요청을 API 서버로 보낸다.
2. API 서비스는 IAM을 질의하여 사용자가 해당 버킷에 READ 권한을 가지고 있는지 확인한다.
3. API 서비스는 해당 객체의 UUID를 메타데이터 저장소에서 가져온다.
4. API 서비스는 해당 UUID를 사용해 데이터 저장소에서 객체 데이터를 가져온다.
5. API 서비스는 HTTP GET 요청에 대한 응답으로 해당 객체 데이터를 반환한다.


## 상세 설계

<img width="530" alt="스크린샷 2024-07-29 오후 8 50 57" src="https://github.com/user-attachments/assets/0874779c-d2f0-43b2-851d-0e03f8e7a207">

### 데이터 라우팅 서비스

데이터 라우팅 서비스는 데이터 노드 클러스터에 접근하기 위한 RESTful 또는 gRPC 서비스를 제공한다. <br>
이 서비스는 다음과 같은 역할을 담당한다.

- 배치 서비스를 호출하여 데이터를 저장할 최적의 데이터 노드를 판단
- 데이터 노드에서 데이터를 읽어 API 서비스에 반환
- 데이터 노드에 데이터 기록

### 배치 서비스

어느 데이터 노드에 데이터를 저장할지 결정하는 역할을 담당한다. <br>
데이터 노드에는 primary/secondary 데이터 노드가 있다. <br>
배치 서비스는 모든 데이터 노드와 지속적으로 박동 메시지를 주고받으며 상태를 모니터링한다. <br>
15초의 유예기간동안 박동 메시지에 응답하지 않는 데이터 노드는 지도에 죽은 노드로 표시한다.

### 데이터 노드

데이터 노드는 실제 객체 데이터가 보관되는 곳이다. 여러 노드에 데이터를 복제함으로써 데이터의 안정성과 내구성을 보증하는데, 이를 **다중화 그룹**이라 부른다.

### 데이터 저장 흐름

<img width="738" alt="스크린샷 2024-07-29 오후 8 53 20" src="https://github.com/user-attachments/assets/0780e1d8-3ff7-4bb8-9bab-fec5f814a4e7">










