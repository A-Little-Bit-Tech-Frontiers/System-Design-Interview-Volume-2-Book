# 결제 시스템

결제 흐름은 자금의 흐름을 반영하기 위해 크게 두 단계로 세분화

- 대금 수신 흐름
- 대금 정산 흐름

전자상거래 사이트 아마존을 예로 들어보자. 구매자가 주문을 하면 아마존의 은행 계좌로 돈이 들어오는데, 이것이 바로 **대금 수신 흐름**  
이 돈은 아마존의 은행 계좌에 있지만 소유권이 전부 아마존에 있는 것은 아니다. 판매자가 상당 부분을 소유하며, 아마존은 수수료를 받고 자금 관리자 역할만 수행한다.  
나중에 제품이 배송되고 나면, 그때까지 묶여있던 판매 대금에서 수수료를 제외한 잔액이 판매자의 은행 계좌로 지급된다. 이것이 **대금 정산 흐름**

<img width="597" alt="image" src="https://github.com/user-attachments/assets/67cbf610-eaa2-40df-bf64-38653eff3d91">


## 대금 수신 흐름

대금 수신 흐름을 개략적인 다이어그램으로 표현하면 아래 그림과 같다.

<img width="619" alt="image" src="https://github.com/user-attachments/assets/be009e89-2900-46d5-bf5a-755ac018851c">


## 결제(외부 PSP 연동)

<img width="571" alt="image" src="https://github.com/user-attachments/assets/e19cd9af-bf77-49a5-b4d2-02460be97ed6">


## 조정

<img width="693" alt="image" src="https://github.com/user-attachments/assets/bdcf0b5e-0c92-465a-ae32-d9ef986b00a6">

시스템 구성 요소가 비동기적으로 통신하는 경우 메시지가 전달되거나 응답이 반환된다는 보장이 없다.  

- 이때 정확성을 보장하기 위해 조정을 수행
- 관련 서비스 간의 상태를 주기적으로 비교하여 일치하는지 확인하는 것
- 일반적으로 결제 시스템의 마지막 방어선으로 받아들여진다.

매일 밤 PSP나 은행은 고객에게 정산 파일을 보낸다. 정산 파일에는 은행 계좌의 잔액과 하루 동안 해당 계좌에서 발생한 모든 거래 내역이 기재되어 있다. **조정 시스템은 정산 파일의 세부 정보를 읽어 원장 시스템과 비교**한다.


## 내부 서비스간 커뮤니케이션


### 비동기 통신

**Exactly Once**

결제 시스템에 발생 가능한 가장 심각한 문제 중 하나는 고객에게 이중으로 청구하는 것이다. 결제 주문이 정확히 한 번만 실행되도록 결제 시스템을 설계하는 것이 중요하다.  
언뜻 보기에는 메시지를 정확히 한 번 전달하는 것은 매우 어려워 보이지만, 문제를 두 부분으로 나누면 훨씬 쉽게 해결할 수 있다. 수학적으로 보자면, 다음의 요건이 충족되면 주어진 연산은 정확히 한 번 실행된다.  

**1. 최소 한 번은 실행된다.  
2. 최대 한 번 실행된다.**

- 재시도
  재시도 메커니즘을 도입할 때는 얼마나 간격을 두고 재시도할지 정하는 것이 중요함  
  - 즉시 재시도
  - 고정 간격
  - 증분 간격
  - 지수적 백오프
  - 취소
  
  적절한 재시도 전략을 결정하는 것은 어렵다. 은탄환은 없기 때문.   
  다만 일반적으로 적용 가능한 지침은, 네트워크 문제가 단시간 내에 해결될 것 같지 않다면 지수적 백오프를 사용하라는 것  
  지나치게 공격적인 재시도 전략은 컴퓨팅 자원을 낭비하고 서비스 과부하를 유발한다. 에러코드를 반환할 때는 Retry-After 헤더를 같이 붙여 보내는 것이 바람직하다.

- 멱등성
  - 멱등성은 최대 한 번 실행을 보장하기 위한 핵심 개념
  - 클라이언트와 서버 간의 통신을 위해서는 일반적으로 클라이언트가 생성하고 일정 시간이 지나면 만료되는 고유한 값을 멱등 키로 사용
  - 스트라이프, 페이팔같은 많은 기술 회사가 UUID를 멱등 키로 권장하며 실제로 널리 쓰인다. 결제 요청의 멱등성을 보장하기 위해서는 HTTP 헤더에 <멱등 키: 값>의 형태로 멱등 키를 추가하면 됨
 
  <br>
 
  <img width="539" alt="image" src="https://github.com/user-attachments/assets/c2e610ff-5cee-4d4c-86c2-69f92d4e59b1">
  
  - 동일한 멱등 키로 동시에 많은 요청을 받으면 결제 서비스는 그 가운데 하나만 처리하고 나머지에 대해서는 429 Too Many Requests 상태 코드를 반환
