# 결제 시스템

## 개략적 설계안

<img width="421" alt="스크린샷 2024-08-01 오후 8 39 01" src="https://github.com/user-attachments/assets/67bc7295-d7ef-43b3-b7d4-f2776414ad40">

### 대금 수신 흐름

#### 결제 서비스

결제 서비스는 사용자로부터 결제 이벤트를 수락하고 결제 프로세스를 조율한다. <br>
일반적으로는 AML/CFT같은 규정을 준수하는지, 자금 세탁이나 테러 자금 조달같은 범죄 행위의 증거가 있는지 평가하는 risk check이다. <br>
일반적으로 위험 확인 서비스는 매우 복잡하고 전문화되어 있기 때문에 제 3자 제공업체를 이용한다.

<img width="670" alt="스크린샷 2024-08-01 오후 8 40 30" src="https://github.com/user-attachments/assets/eaff40ef-5f26-4849-b106-1a1a140d92cf">

#### 결제 실행자

결제 실행자는 결제 서비스 공급자를 통해 결제 주문 하나를 실행한다. <br>
하나의 결제 이벤트에는 여러 결제 주문이 포함될 수 있다.

#### 결제 서비스 공급자

결제 서비스 공급자는 A 계정에서 B 계정으로 돈을 옮기는 역할을 한다. <br>
예제의 경우엔 구매자의 신용 카드 계좌에서 돈을 인출하는 역할을 한다.

#### 원장

결제 트랜잭션에 대한 금융 기록이다. <br>
사용자가 판매자에게 1달러를 결제하면 사용자로부터 1달러를 인출하고 판매자에게 1달러를 지급하는 기록을 남긴다. <br>
원장 시스템은 웹사이트의 총 수익을 계산하거나 향후 수익을 예측하는 등의 결제 후 분석에서 중요하다.

#### 지갑

판매자의 계정 잔액을 기록한다. 특정 사용자가 결제한 총 금액을 기록할 수도 있다.

### 결제 서비스 데이터 모델

<img width="482" alt="스크린샷 2024-08-01 오후 8 45 02" src="https://github.com/user-attachments/assets/d301ce02-b504-4fec-a099-316bc1645191">
<img width="379" alt="스크린샷 2024-08-01 오후 8 45 05" src="https://github.com/user-attachments/assets/7f3854cb-2680-4c7c-9769-f3e07ba10f2d">

1. payment_order_status의 초기값은 NOT_STARTED다.
2. 결제 서비스는 결제 실행자에 주문을 전송하면 payment_order_status의 값을 EXECUTING으로 바꾼다.
3. 결제 서비스는 결제 처리자의 응답에 따라 payment_order_status의 값을 SUCCESS나 FAIL로 변경한다.

SUCCESS로 결정되면 결제 서비스는 지갑 서비스를 호출하여 판매자 잔액을 업데이트하고, wallet_updated의 값을 TRUE로 업데이트한다. <br>
이 절차가 끝나면 결제 서비스는 다음 단계로 원장 서비스를 호출하여 원장 데이터베이스에 ledger_updated 필드를 TRUE로 갱신한다. <br>
동일한 checkout_id 아래의 모든 결제 주문이 처리되면 결제 서비스는 결제 이벤트 테이블의 is_payment_done을 TRUE로 업데이트한다.

### 복식부기 원장 시스템

<img width="243" alt="스크린샷 2024-08-01 오후 8 48 51" src="https://github.com/user-attachments/assets/eda5832d-f744-48ae-b1a3-674272095bc3">

원장 시스템에는 복식부기(double-entry)라는 아주 중요한 설계 원칙이 있다. <br>
복식부기 시스템에서 모든 거래 항목의 합계는 0이어야 한다. <br>
이 시스템을 활용하면 자금의 흐름을 시작부터 끝까지 추적할 수 있으며, 결제 주기 전반에 걸쳐 일관성을 보장할 수 있다.

## 상세 설계

### PSP 연동

<img width="655" alt="스크린샷 2024-08-01 오후 8 54 17" src="https://github.com/user-attachments/assets/aa41e009-5469-4157-a518-bb14319fef5f">

### 조정

시스템 구성 요소가 비동기적으로 통신하는 경우 메시지가 전달되거나 응답이 반환된다는 보장이 없다. <br>
이는 시스템 성능을 높이기 위해 비동기 통신을 자주 사용하는 결제 관련 사업에 일반적인 문제다. <br>
**조정**을 이용하여 관련 서비스간의 상태를 주기적으로 비교하여 일치하는 지 확인하여, 정확성을 보장할 수 있다.

매일 밤 PSP나 은행은 고객에게 정산 파일을 보내는데, 여기에 은행 계좌의 잔액과 하루 동안 계좌에서 발생한 모든 거래 내역이 기재되어 있다. <br>
조정 시스템은 정산 파일의 세부 정보를 읽어 원장 시스템과 비교한다.

<img width="658" alt="스크린샷 2024-08-01 오후 8 57 17" src="https://github.com/user-attachments/assets/9943415d-a2c5-4b42-ac70-3c359a6d337d">

### 결제 실패 처리

<img width="740" alt="스크린샷 2024-08-01 오후 8 58 31" src="https://github.com/user-attachments/assets/997975cd-df57-432c-92b5-c82d0fd89004">

1. 재시도 가능한지 확인한다.
   2. 재시도 가능 실패는 재시도 큐로 보낸다.
   3. 잘못된 입력과 같이 재시도가 불가능한 경우 오류 내역을 데이터베이스에 저장한다.
2. 결제 시스템은 재시도 큐에 쌓인 이벤트를 읽어 실패한 결제를 재시도한다.
3. 결제 거래가 다시 실패하는 경우
   4. 재시도 횟수가 임계값 이내라면 해당 이벤트를 다시 재시도 큐로 보낸다.
   5. 재시도 횟수가 임계값을 넘으면 해당 이벤트를 실패 메시지 큐에 넣는다.

### 멱등성

멱등성은 최대 한 번 실행을 보장하기 위한 핵심 개념이다. <br>
**전자상거래 웹사이트에서 멱등 키는 보통 결제가 이루어지기 전 장바구니 ID다.**

<img width="466" alt="스크린샷 2024-08-01 오후 9 00 54" src="https://github.com/user-attachments/assets/f1873fc5-d644-4f3f-87b7-ef64324dd228">






